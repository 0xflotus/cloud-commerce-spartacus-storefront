#!/bin/bash

#################################################################################################################################
# Variables
#################################################################################################################################

RED='\033[0;31m'
NC='\033[0m'

#################################################################################################################################


echo
test -f log.txt && rm log.txt


#################################################################################################################################
# Unit tests
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running unit tests
=================================================================================================================================
EOF

ng test storefrontapp --watch=false 2>&1 | tee log.txt

if grep -q 'FAILED' "log.txt";
then
        rm log.txt
        echo -e "${RED}Error: One or more unit tests failed.${NC}"
        exit 1;
else
        echo 'All unit tests passed'
fi

#################################################################################################################################


echo


#################################################################################################################################
# Unit test coverage
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng test --code-coverage
=================================================================================================================================
EOF

ng test storefrontapp --code-coverage --watch=false 2>&1 | tee log.txt

##################################################################################################################################


rm log.txt
echo


#################################################################################################################################
# yarn 
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running yarn
=================================================================================================================================
EOF

yarn || {
	rm log.txt
	echo -e "${RED}Error: Failed to install dependencies.${NC}"
	exit 1
}

#################################################################################################################################


echo


#################################################################################################################################
# ng build --aot 
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng build --aot
=================================================================================================================================
EOF

ng build storefrontapp --aot || {
	echo -e "${RED}Error: Failed to build aot.${NC}"
	exit 1
}

#################################################################################################################################


echo


#################################################################################################################################
# ng build --prod
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng build --prod 
=================================================================================================================================
EOF

ng build storefrontapp --prod || {
	echo -e "${RED}Error: Failed to build prod in spaccelerator.${NC}"
	exit 1
}

#################################################################################################################################


echo
echo "Please enter the path to your commercewebservices-module/ycommercewebservices/web/webroot directory or press 'c' to continue without providing a path: " 
read WEBROOT_DIR

while [[ ! -d "$WEBROOT_DIR" && "$WEBROOT_DIR" != "c" ]];
do
  	echo "The path you entered was incorrect, please either enter the correct path to your commercewebservices-module/ycommercewebservices/web/webroot directory or enter 'c' to continue without providing a path: "
	read WEBROOT_DIR
done

SPA_DIR="$WEBROOT_DIR/spa"


#################################################################################################################################
# Copying storefrontapp/dist/* to commercewebservices-module/ycommercewebservices/web/webroot/spa
#################################################################################################################################

if [ "$WEBROOT_DIR" != "c" ]; 
then
cat << EOF

=================================================================================================================================
Running ng build --prod --base-href=/rest/spa/ in spaccelerator
=================================================================================================================================
EOF

	ng build storefrontapp --prod --base-href=/rest/spa/

cat << EOF
=================================================================================================================================
Copying dist/* to commercewebservices-module/ycommercewebservices/web/webroot/spa
=================================================================================================================================
EOF

  	test -d "$SPA_DIR" || mkdir "$SPA_DIR"
	cp -R dist/. "$SPA_DIR" && {
		echo "Files copied successfully."
	}
fi

#################################################################################################################################


echo


#################################################################################################################################
# ng lint 
#################################################################################################################################

cat << EOF
=================================================================================================================================
Running ng lint 
=================================================================================================================================
EOF

ng lint || {
	exit 1
}

#################################################################################################################################




cat << EOF
=================================================================================================================================
                          ADDITIONAL THINGS TO MANUALLY CHECK BEFORE MERGING OR PUSHING CHAGES
=================================================================================================================================
1) Open the index.html file located inside your spaccelerator/coverage folder and make sure that the unit test coverage for the 
   modules or components you've worked on is at least 80%.

2) If you have provided the correct path to your ycommercewebservices/web/webroot/ directory then open your web browser and make 
   sure that SPA is running on https://localhost:9002/rest/spa/.

EOF


echo